name: CI

on:
  workflow_dispatch:
  push:
    branches: [master, test-pr-workflows]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  examples:
    runs-on: ubuntu-latest
    name: Test ${{ matrix.project }}
    strategy:
      fail-fast: false
      matrix:
        project:
          - browser-add-readable-stream
          - browser-angular
          - browser-create-react-app
          - browser-esbuild
          - browser-exchange-files
          - browser-ipns-publish
          - browser-lit
          - browser-mfs
          - browser-nextjs
          - browser-readablestream
          - browser-script-tag
          - browser-service-worker
          - browser-sharing-node-across-tabs
          - browser-video-streaming
          - browser-vite
          - browser-vue
          - browser-webpack
          - circuit-relaying
          - custom-ipfs-repo
          - custom-ipld-formats
          - custom-libp2p
          - http-client-browser-pubsub
          - http-client-bundle-webpack
          - http-client-name-api
          - http-client-upload-file
          - ipfs-101
          #- ipfs-client-add-files
          - run-in-electron
          - running-multiple-nodes
          - traverse-ipld-graphs
          - types-use-ipfs-from-ts
          - types-use-ipfs-from-typed-js
    defaults:
      run:
        working-directory: examples/${{ matrix.project }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: lts/*
      - run: npm install && npx -y playwright install-deps
      - uses: GabrielBB/xvfb-action@86d97bde4a65fe9b290c0b3fb92c2c4ed0e5302d # https://github.com/GabrielBB/xvfb-action/releases/tag/v1.6
        name: Run tests
        with:
          run: npm test
          working-directory: examples/${{ matrix.project }}

  monorepo:
    runs-on: ubuntu-latest
    name: Test monorepo
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm install && npx -y playwright install-deps
      - uses: GabrielBB/xvfb-action@86d97bde4a65fe9b290c0b3fb92c2c4ed0e5302d # https://github.com/GabrielBB/xvfb-action/releases/tag/v1.6
        name: Run test:examples
        with:
          run: npm run test:examples
